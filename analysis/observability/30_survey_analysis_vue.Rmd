---
title: "DevDaySurvey-Vue"
author: "Anders Sundelin"
date: "2025-05-04"
output: html_document
params:
    cache: "../.cache"
    output: "../output"
    reloo: FALSE
    cores: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggrepel)
library(forcats)
library(stringr)
library(lubridate)
library(bookdown)
library(ggformula)
library(brms)
library(bayesplot)
library(tidybayes)
```

```{r ingest}
source("ingest_survey_data.R")
raw <- ingest_survey_data("../data/TrainingDayResponses.xlsx")
vue <- vue_data(raw)
MODEL_PREFIX <- "vue"
```

## EDA, visualizations
```{r}
vue_usable <- get_vue_usable(vue)
vue_ease_of_use <- get_vue_ease_of_use(vue)
vue_accessible <- get_vue_accessible(vue)
vue_intent <- get_vue_intend_use(vue)
```

```{r}
rbind(vue_usable |> mutate(trait="usable", rate=usable) |> select(trait, site, rate),
      vue_ease_of_use |> mutate(trait="ease-of-use", rate=ease_of_use) |> select(trait, site, rate),
      vue_accessible |> mutate(trait="accessible", rate=accessible) |> select(trait, site, rate),
      vue_intent |> mutate(trait="intent-to-use", rate=intent) |> select(trait, site, rate)
      ) |> group_by(trait) |> ggplot(aes(x=as.numeric(rate), fill=site)) +
  geom_histogram(stat="count", position="dodge") +
  scale_x_continuous(name="rating", breaks = 1:7, labels = c("Extremely\nLikely", "Quite\nLikely", "Slightly\nLikely", "Neutral", "Slightly\nUnlikely", "Quite\nUnlikely", "Extremely\nUnlikely") ) +
  facet_wrap(~trait, ncol=2) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

# Vue Usability

## Model 1 (Population-level intercept-only)

```{r}
d <- vue_usable |> select(usable)
formula <- usable | thres(6) ~ 1
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

### Prior predictive checks

```{r m1_ppc}
M1_ppc <- brm(
  data = d,
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  sample_prior = "only",
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1
)
```

```{r}
pp_check(M1_ppc, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Priors look OK, but we also note the extreme positive attitude of the respondents.
Possibly, the single `Extremely Unlikely` answer is a mistake.
But it does not matter in a Bayesian context, as the evidence for positive attitude towards usability is overwhelming.

### Model execution and diagnostics

```{r m1}
M1 <- brm(
  data = d,
  file = modelfile("M1"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- M1
```


```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

The chains mix well, and `disc` is flat as the variance is fixed to 1.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Diagnostics look good, one $N_{eff}$ slightly above 0.3.

```{r loo-m1}
(loo <- loo(M1) )
plot(loo)
```

All LOO-CV values are good, the highest around 0.6, well below the 0.7 limit.

```{r}
pp_check(M1, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Our model fits the data well, and are still allowing extreme values (6 or 7).

```{r}
summary(M1)
```

```{r}
plot_M1_latent_distribution(m, "usable")
```

Just like the data indicates, the probability of XL is over 50%.
The single XUL answer also provides a bit of a tail, but this is OK, we would expect any answer to be possible.

```{r}
plot_M1_posterior_mean(m, "usability", function(df) {df |> summarize(mean(as.numeric(usable))) })
```

Posterior expected mean ranges between `Extremely Likely` and `Quite Likely`, with the point-estimate positioned right between.

```{r}
vue_usable |> summarise(mean(as.numeric(usable)))
```

Sample average is even closer to XL (about $\frac{1}{4}$ of the distance between XL and QL).

## Vue Usability per site (no pooling)

```{r}
d <- vue_usable |> select(usable, site)
formula <- usable | thres(6) ~ 1 + site
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

### Prior predictive checks
```{r m2_ppc}
M2_ppc <- brm(
  data = d,
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  sample_prior = "only",
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1
)
m <- M2_ppc
```

One divergent transition, but this is priors only, so nothing to worry about.
Could probably be fixed by adjusting step size.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

Caterpillar plots look good, and `disc` is fixed for this model also.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

The lowest $N_{eff}$ value is above 0.25, and all diagnostics look OK.

```{r}
pp_check(M2_ppc, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Priors looking good, all values are present.

### Model execution and diagnostics

```{r m2}
M2 <- brm(
  data = d,
  file = modelfile("M2"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- M2
```

No divergent transitions with the adjusted step size, the model works well

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

Caterpillar plots look good, and `disc` is fixed for this model also.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

The lowest $N_{eff}$ value is around 0.4, and all diagnostics are OK.

```{r}
pp_check(m, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior checks are also OK.

```{r loo-m2}
(loo <- loo(M2))
plot(loo)
```

All Pareto-k values are below 0.7, two between 0.5 and 0.6 (possibly the XUL outlier).
But nothing that stops us from using the model. We should be able to trust the predictions.

```{r}
summary(M2)
```

```{r}
plot_M2_latent_distribution(M2, "usability")
```

Both sites tend positive, but judging from this data, the Indian cohort are more positive (more probability mass to the left of XL for the India curve).

```{r}
plot_M2_posterior_mean(M2, "usability", usable_mean)
```

This is also visible in the posterior expected mean plot.
The Indian cohort distribution is significantly more positive than the European.

```{r}
d |> group_by(site, usable) |> tally()
```

Quite funny, the Extremely Unlikely answer was actually given by an Indian respondent.
But the Indian cohort had many more XL answers, so its distribution anyway tended more towards XL.

```{r}
d |> group_by(site) |> summarize(mean(as.numeric(usable)))
```

Quite similar sample means for the two cohorts.

## Usability per site (Multilevel intercept, per respondent)

```{r}
d <- vue_usable |> select(usable, site, id)
formula <- usable | thres(6) ~ 1 + site + (1 | id)
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b),
            prior(exponential(5), class = sd))
validate_prior(prior = priors,
               data=d,
               family=cumulative(logit),
               formula=formula)
```

### Prior predictive checks

```{r m3_ppc}
M3_ppc <- brm(
  data = d,
  family = cumulative(logit),
  formula = formula,
  prior = priors,
  drop_unused_levels = F,
  sample_prior = "only",
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
```
```{r}
pp_check(M3_ppc, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

These priors are looking good, note that now all outcomes occur with very similar probabilities.
How does the groups look?

```{r}
pp_check(M3_ppc, type = "bars_grouped", group="id", ndraws = 500, size = 1/2, fatten = 3/2)
```

Grouped PPCs are also looking good, all levels occur with some probability.
We should be able to trust these priors.

### Model execution and diagnostics

```{r m3}
M3 <- brm(
  data = d,
  file = modelfile("M3"),
  family = cumulative(logit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- M3
```

Adjusting step size `adapt_delta` fix any divergent transitions.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

These caterpillars look good, and the `disc` continues to be flat, as it is fixed at 1.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

$\hat{R}$ values are looking good, but quite many $N_{eff}$ values are low (below 0.2, but not below 0.1).

```{r}
summary(M3)
```

```{r}
pp_check(M3, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior checks show that all outcomes have some probability of occuring.

```{r}
pp_check(M3, type = "bars_grouped", group="id", ndraws = 500, size = 1/2, fatten = 3/2)
```

Groups also look OK.

```{r}
plot_M2_latent_distribution(M3, "usability")
```

Indian respondents continue to be more positive in this model.

```{r}
plot_M2_posterior_mean(M3, "usability", usable_mean)
```

We note that the 95% credible interval is considerably wider now.
This is because this model is a bit more skeptical towards extreme values.

## Multilevel, varying variance

```{r}
d <- vue_usable |> select(usable, site, id)
formula <- bf(usable | thres(6) ~ 1 + site + (1 | id)) +
           lf(disc              ~ 0 + site, cmc = FALSE)
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b),
            prior(normal(0, log(2)/2), class = b, dpar=disc),
            prior(exponential(5), class = sd)
            )
validate_prior(prior = priors,
               data=d,
               family=cumulative(logit),
               formula=formula)

```
```{r m4_ppc}
M4_ppc <- brm(
  data = d,
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  sample_prior = "only",
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- M4_ppc
```

No divergent transitions.

```{r}
pp_check(M4_ppc, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Prior predictive checks look OK, slightly higher in the middle of the scale again.

```{r m4}
M4 <- brm(
  data = d,
  file = modelfile("M4"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99),
  init = 0
)
m <- M4
```

No divergent transitions with the adjusted step size and initial value.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

These caterpillars look good, and the `disc` is now also mixed, and seems to converge.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Quite many bad $N_{eff}$ values, but all of them higher than 0.2, so we should anyway be able to use the model.

```{r loo-m4}
( loo <- loo(M4) )
plot(loo)
```

One observation are above the limit of 0.7.

Setting the RELOO option will run the exact Pareto calculation (this is not dune by default, to save run time).

```{r reloo-m4, eval=params$reloo}
reloofile <- paste0(modelfile("reloo-M4"), ".rds")
if (file.exists(reloofile)) {
    (reloo <- readRDS(reloofile))
} else {
    Sys.time()
    (reloo <- reloo(M4, loo, chains=CHAINS, cores=CORES) )
    Sys.time()
    saveRDS(reloo, reloofile)
}
```
Note that the reloo results are cached, and included in the docker image by default.
If you want to reproduce the reloo manually, set a separate cache dir (and mount it into the docker image), and enable the RELOO environment variable.

```{r plot_reloo-m4, eval=params$reloo}
plot(reloo)
```

Running reloo, which does exact LOO-CV (leaving out one problematic observation at a time) reveals that all Pareto-k estimates are below 0.7 (the highest around 0.6), so we should be able to use the model inferences.

```{r}
summary(M4)
```

```{r}
plot_M4_latent_distribution(M4, "usability-varying")
```

Quite similar shape for the two sites.

```{r}
plot_M4_posterior_mean(M4, "usability-varying", usable_mean, limits=c(1,7))
```

Indian cohort is still quite a bit more positive.

```{r}
expected_value_M4(M4)
```

Which is also visible in the expected value (which includes the 95% Credible Interval)

# Vue Ease-of-Use

## Model 1: Population-level intercept

```{r}
d <- vue_ease_of_use |> select(ease_of_use)
formula <- ease_of_use | thres(6) ~ 1
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```
```{r e1}
E1 <- brm(
  data = d,
  file = modelfile("E1"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- E1
```

No divergent transitions with the adjusted step size.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

The chains seem to mix well. The disc is flat as the variance is fixed to 1.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Diagnostics look good, even though one $N_{eff}$ value lies around 0.3.

```{r loo-e1}
(loo <- loo(E1))
plot(loo)
```

All LOO-CV values are OK, way below 0.7.

```{r}
pp_check(m, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior checks are OK.

```{r}
plot_M1_latent_distribution(E1, "ease of use")
```

Almost half the probability lies on XL.

```{r}
plot_M1_posterior_mean(E1, "ease of use", ease_of_use_mean)
```

And this is also visible in the posterior expected mean which lies between XL and QL (around $\frac{3}{4}$ of the way towards QL.

```{r}
vue_ease_of_use |> summarise(mean(as.numeric(ease_of_use)))
```

The sample mean is almost half-way through XL and QL.

## Ease of use, per site, no pooling
```{r}
d <- vue_ease_of_use |> select(ease_of_use, site)
formula <- ease_of_use | thres(6) ~ 1 + site
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```
```{r e2}
E2 <- brm(
  data = d,
  file = modelfile("E2"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- E2
```

No divergent transitions with the adjusted step size.

```{r}
pp_check(m, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

```{r}
plot_M2_latent_distribution(E2, "ease of use")
```

Slightly more positive attitude towards the India cohort (more probability mass to the left of XL).

```{r}
plot_M2_posterior_mean(E2, "ease of use", ease_of_use_mean)
```

Is also visible in the posterior expected mean, which is leaning more towards XL for the India cohort than for the European.

## Ease of use, per site, regularized on respondent

```{r}
d <- vue_ease_of_use |> select(ease_of_use, site, id)
formula <- ease_of_use | thres(6) ~ 1 + site + (1 | id)
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b),
            prior(exponential(5), class = sd))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```
```{r e3}
E3 <- brm(
  data = d,
  file = modelfile("E3"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1
)
m <- E3
```

No divergent transitions.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

These caterpillars look good, and the `disc` continues to be flat, as it is fixed at 1.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

More low $N_{eff}$ values now, though none below 0.25.

```{r}
pp_check(m, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

```{r}
pp_check(m, type = "bars_grouped", group="id", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior checks look good, both for the populaton and grouped per respondent.

```{r}
plot_M2_latent_distribution(E3, "ease-of-use")
```

This model is more sceptical towards extreme positivism. XL is no longer occupying almost 50% probability (which is most likely a correct assessment when looking at a population).

```{r}
plot_M2_posterior_mean(E3, "ease-of-use", ease_of_use_mean)
```

Posterior expected means are still more positive for the Indian population, but the difference is much smaller.

## Ease-of-use, pooled on respondent, varying variance per site
```{r}
d <- vue_ease_of_use |> select(ease_of_use, site, id)
formula <- bf(ease_of_use | thres(6) ~ 1 + site + (1 | id)) +
           lf(disc                   ~ 0 + site, cmc = FALSE)
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b),
            prior(normal(0, log(2)/2), class = b, dpar=disc),
            prior(exponential(5), class = sd)
            )
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

```{r e4}
E4 <- brm(
  data = d,
  file = modelfile("E4"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99),
  init = 0
)
m <- E4
```

Adjusting step size and starting point solves all divergent transitions and singularities.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

These caterpillars look good, and the `b_disc_siteIndia` also mixes well.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Many low $N_{eff}$ values, though none below 0.25. Overall, the diagnostics look good.

```{r loo-e4}
( loo <- loo(E4) )
plot(loo)
```

One observation have Pareto-k above 0.7.
Setting the RELOO option will run the exact Pareto calculation (this is not dune by default, to save run time).

```{r reloo-e4, eval=params$reloo}
reloofile <- paste0(modelfile("reloo-E4"), ".rds")
if (file.exists(reloofile)) {
    (reloo <- readRDS(reloofile))
} else {
    Sys.time()
    (reloo <- reloo(E4, loo, chains=CHAINS, cores=CORES) )
    Sys.time()
    saveRDS(reloo, reloofile)
}
```
Note that the reloo results are cached, and included in the docker image by default.
If you want to reproduce the reloo manually, set a separate cache dir (and mount it into the docker image), and enable the RELOO environment variable.

```{r plot_reloo-e4, eval=params$reloo}
plot(reloo)
```

Running reloo, which does exact LOO-CV (leaving out one problematic observation at a time) reveals that all Pareto-k estimates are below 0.7 (the highest slightly below 0.5), so we should be able to use the model inferences.


```{r}
summary(E4)
```

```{r}
plot_M4_latent_distribution(E4, "ease-of-use")
```

The India population are more positive, and the distribution is narrower, focused between XL and QL.

```{r}
plot_M4_posterior_mean(E4, "ease-of-use-varying", ease_of_use_mean, limits=c(1,7))
```

The posterior expected value for India is closer to QL for the India cohort, and somewhere between `Quite Likely` and `Slightly Likely` for the European.

# Accessibility

## Accessibility, intercept-only

```{r}
d <- vue_accessible |> select(accessible)
formula <- accessible | thres(6) ~ 1
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

```{r a1}
A1 <- brm(
  data = d,
  file = modelfile("A1"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- A1
```
No divergent transitions with the adjusted step size.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

The chains seem to mix well. The disc is flat as the variance is fixed to 1.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Diagnostics look good, one low $N_{eff}$ value, slightly more than 0.3.

```{r loo-a1}
(loo <- loo(A1) )
plot(loo)
```

All loo values are good.

```{r}
pp_check(A1, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior checks look good too.

```{r}
plot_M1_latent_distribution(A1, "accessible")
```

More than 50% probability of scoring QL or higher

```{r}
pp_check(A1, type = "hist", ndraws = 8, binwidth = 1) +
  scale_x_continuous(breaks = 1:7) +
  ggtitle("Draws from the posterior")
```

Eight example draws from the posterior distribution also indicate an overwright of QL.

```{r}
plot_M1_posterior_mean(A1, "accessible", accessible_mean)
```

The model is 95% certain that the posterior expected mean is higher than Slightly Likely.

```{r}
vue_accessible |> summarise(mean(as.numeric(accessible)))
```

Sample mean is even more positive.

## Accessibility, per site

```{r}
d <- vue_accessible |> select(accessible, site)
formula <- accessible | thres(6) ~ 1 + site
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

```{r a2}
A2 <- brm(
  data = d,
  file = modelfile("A2"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1
)
m <- A2
```

No divergent transitions.

```{r}
pp_check(m, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior checks looks OK, but is not reaching up to QL all the way.

```{r}
plot_M2_latent_distribution(A2, "accessible")
```

India is slightly more positive than Europe.

```{r}
plot_M2_posterior_mean(A2, "accessible", accessible_mean)
```

The posterior expected mean is higher for India also.

## Accessibility, per site, regularized per respondent

```{r}
d <- vue_accessible |> select(accessible, site, id)
formula <- accessible | thres(6) ~ 1 + site + (1 | id)
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b),
            prior(exponential(5), class = sd))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

```{r a3}
A3 <- brm(
  data = d,
  file = modelfile("A3"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- A3
```

Adjusting `adapt_delta` fixes the 3 divergent transitions.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

Caterpillar plots look OK, and `disc` is flat, as the variance is fixed at 1.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Quite many $N_{eff}$ values are around 0.2, but none below 0.1.

```{r}
pp_check(m, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

```{r}
pp_check(m, type = "bars_grouped", group="id", ndraws = 500, size = 1/2, fatten = 3/2)
```

Both population- and group-level posterior checks look OK.

```{r}
plot_M2_latent_distribution(A3, "accessible")
```

India continues to be more positive.

```{r}
plot_M2_posterior_mean(A3, "accessible", accessible_mean)
```

And this is reflected in the posterior expected mean value.

## Accessibility, pooled on respondent, varying variance per site

```{r}
d <- vue_accessible |> select(accessible, site, id)
formula <- bf(accessible | thres(6) ~ 1 + site + (1 | id)) +
           lf(disc                   ~ 0 + site, cmc = FALSE)
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b),
            prior(normal(0, log(2)/2), class = b, dpar=disc),
            prior(exponential(5), class = sd)
            )
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

```{r a4}
A4 <- brm(
  data = d,
  file = modelfile("A4"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99),
  init = 0
)
m <- A4
```

Reducing step size and fixing starting point fixes divergent transitions and prevents model veering off track.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

Caterpillar plots are OK, including the `b_disc_siteIndia`.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Some low $N_{eff}$ values, but none below 0.10. $\hat{R}$ is good.

```{r loo-a4}
( loo <- loo(A4) )
plot(loo)
```

All loo values are OK, the highest Pareto-k is less than 0.5

```{r}
pp_check(A4, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

```{r}
pp_check(A4, type = "bars_grouped", group="id", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior checks are OK, both on population- and group-level.

```{r}
summary(A4)
```

```{r}
plot_M4_latent_distribution(A4, "accessibility")
```

The India cohort is narrower than the Europe reference category.
And also more positive overall.

```{r}
plot_M4_posterior_mean(A4, "accessibility-varying", accessible_mean, limits=c(1,7))
```

This is also reflected in the posterior expected mean, where Indian cohort leans much more towards QL than Europe.

# Intent to use

## Intent, intercept-only

```{r}
d <- vue_intent |> select(intent)
formula <- intent | thres(6) ~ 1
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

```{r i1}
I1 <- brm(
  data = d,
  file = modelfile("I1"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- I1
```
No divergent transitions, after adjusting `adapt_delta` (2 with the default setting).

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

The chains seem to mix well. The disc is flat as the variance is fixed at 1.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

The lowest $N_{eff}$ value is above 0.3.

```{r loo-i1}
(loo <- loo(I1) )
plot(loo)
```

All LOO-CV values are ok, well below 0.7.

```{r}
pp_check(I1, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior predictions look OK.

```{r}
plot_M1_latent_distribution(I1, "intent")
```

Very positive sentiment towards intent to use the Vue components.

```{r}
pp_check(I1, type = "hist", ndraws = 8, binwidth = 1) +
  scale_x_continuous(breaks = 1:7) +
  ggtitle("Example draws from the posterior")
```

Eight examples of other draws from this posterior.
There is still probability (though small) to see unlikely ratings, e.g., QUL, XUL.

```{r}
plot_M1_posterior_mean(I1, "intent", intent_mean)
```

Posterior mean is close to Quite Likely, and >95% certain it is greater than Slightly Likely.

```{r}
vue_intent |> summarise(mean(as.numeric(intent)))
```

Sample mean is right between XL and QL.

## Intent, per site

```{r}
d <- vue_intent |> select(intent, site)
formula <- intent | thres(6) ~ 1 + site
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```
```{r i2}
I2 <- brm(
  data = d,
  file = modelfile("I2"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- I2
```

Adjusting the step size removed the few divergent transitions.

```{r}
pp_check(m, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior predictions match up well.

```{r}
plot_M2_latent_distribution(I2, "intent")
```

Identical distributions for Europe and India.

```{r}
plot_M2_posterior_mean(I2, "intent", intent_mean)
```

Also visible in the posterior expected mean, which is close to QL, and 95% certain it is SL or higher.

## Intent, per site, regularized per respondent

```{r}
d <- vue_intent |> select(intent, site, id)
formula <- intent | thres(6) ~ 1 + site + (1 | id)
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b),
            prior(exponential(5), class = sd))
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

```{r i3}
I3 <- brm(
  data = d,
  file = modelfile("I3"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99)
)
m <- I3
```

The default step size will cause 40 divergent transitions, but those are fixed by reducing the step size from 0.95 to 0.99.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

Caterpillar plots look OK, and `disc` is still fixed at 1.

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Diagnostics also look OK, though there are some low $N_{eff}$ values, but all above 0.25.

```{r}
pp_check(m, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

```{r}
pp_check(m, type = "bars_grouped", group="id", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior predictions look OK, both on a population and group level.

```{r}
plot_M2_latent_distribution(I3, "intent")
```

```{r}
plot_M2_posterior_mean(I3, "intent", intent_mean)
```

Identical distributions for Europe and India.

## Intent-to-use, pooled on respondent, varying variance per site

```{r}
d <- vue_intent |> select(intent, site, id)
formula <- bf(intent | thres(6) ~ 1 + site + (1 | id)) +
           lf(disc              ~ 0 + site, cmc = FALSE)
priors <- c(prior(normal(-1.068, 1), class = Intercept, coef = 1),
            prior(normal(-0.566, 1), class = Intercept, coef = 2),
            prior(normal(-0.180, 1), class = Intercept, coef = 3),
            prior(normal( 0.180, 1), class = Intercept, coef = 4),
            prior(normal( 0.566, 1), class = Intercept, coef = 5),
            prior(normal( 1.068, 1), class = Intercept, coef = 6),
            prior(normal(0, 1), class = b),
            prior(normal(0, log(2)/2), class = b, dpar=disc),
            prior(exponential(5), class = sd)
            )
validate_prior(prior = priors,
               data=d,
               family=cumulative(probit),
               formula=formula)
```

```{r i4}
I4 <- brm(
  data = d,
  file = modelfile("I4"),
  family = cumulative(probit),
  formula=formula,
  prior = priors,
  drop_unused_levels = F,
  backend="cmdstanr",
  warmup = 1000,
  iter  = ITERATIONS,
  chains = CHAINS,
  cores = CORES,
  seed = 1,
  control = list(adapt_delta=0.99),
  init = 0
)
m <- I4
```

Adjusting step size and initial sample value removes any divergent transitions or starting point errors.

```{r}
p <- mcmc_trace(m)
pars <- levels(p[["data"]][["parameter"]])
plots <- seq(1, to=length(pars), by=6)
lapply(plots, function(i) {
  start <- i
  end <- start+5
  mcmc_trace(m, pars = na.omit(pars[start:end]))
  })
```

Chains mix well, also `b_disc_siteIndia`

```{r}
mcmc_plot(m, type="rhat")
mcmc_plot(m, type="rhat_hist")
mcmc_plot(m, type="neff")
mcmc_plot(m, type="neff_hist")
```

Adding variability for the variance actually helped the lowest $N_{eff}$ values, which are now over 0.3.

```{r loo-i4}
( loo <- loo(I4) )
plot(loo)
```

All loo values are OK, the highest around 0.6, below the limit of 0.7.

```{r}
pp_check(I4, type = "bars", ndraws = 500, size = 1/2, fatten = 3/2)
```

```{r}
pp_check(I4, type = "bars_grouped", group="id", ndraws = 500, size = 1/2, fatten = 3/2)
```

Posterior plots look OK, this model mainly expects XL and QL, but allows other ratings with some probability.


```{r}
summary(I4)
```

```{r}
plot_M4_latent_distribution(I4, "intent-varying")
```

Both distributions are similar, though the India one is slightly narrower.

```{r}
plot_M4_posterior_mean(I4, "intent-varying", intent_mean, limits=c(1,7))
```

Posterior expected mean is also similar, around Quite Likely, but stretching into SL territory.

## Model comparison

```{r}
loo(M1, M2, M3, M4)
```

All models are within one sd of each other.
This indicates that they have similar predictive power.

```{r}
loo(E1, E2, E3, E4)
```

E3 and E4 are similar, but the simpler models have worse performance.

```{r}
loo(A1, A2, A3, A4)
```

A4 and A3 are similar, but the simpler models have worse performance.

```{r}
loo(I1, I2, I3, I4)
```

All four Intercept models are quite alike, though I2 is slightly lower (but the difference is minimal, -0.9 in elpd diff.

```{r}
expected_value_M4(M4)
expected_value_M4(E4)
expected_value_M4(A4)
expected_value_M4(I4)
```

The expected value are similar (meaning, within the 95% probability interval) for all metrics.